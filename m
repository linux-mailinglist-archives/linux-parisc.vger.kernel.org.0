Return-Path: <linux-parisc-owner@vger.kernel.org>
X-Original-To: lists+linux-parisc@lfdr.de
Delivered-To: lists+linux-parisc@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 6B4BE3FF34B
	for <lists+linux-parisc@lfdr.de>; Thu,  2 Sep 2021 20:35:51 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1346888AbhIBSgs (ORCPT <rfc822;lists+linux-parisc@lfdr.de>);
        Thu, 2 Sep 2021 14:36:48 -0400
Received: from mail.kernel.org ([198.145.29.99]:52740 "EHLO mail.kernel.org"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S241887AbhIBSgs (ORCPT <rfc822;linux-parisc@vger.kernel.org>);
        Thu, 2 Sep 2021 14:36:48 -0400
Received: by mail.kernel.org (Postfix) with ESMTPSA id D91DC6102A
        for <linux-parisc@vger.kernel.org>; Thu,  2 Sep 2021 18:35:49 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=k20201202; t=1630607749;
        bh=CYDUYhdYxRc5HjJ4+TNUGhloUFFMUW1cUzu4kLDhFuc=;
        h=References:In-Reply-To:From:Date:Subject:To:Cc:From;
        b=j2RJTVA71fHAzOkTAN0KuH4V3qpCzP5lPwIeP0EceRgi54RtJ8BeFQq+NzlA7Fj2j
         x6nKjaCF98tVFGBktg8tXJnKmWkLF5uDydR15CFztdqsA6Z6Y63cKCgQ6B6PmsqN5Z
         ZhZeyP+HSm1TJMOtUc1rADH1XFYa+lOq5soblE+U3q4P79sM4+V+woO63jkOeUXqy5
         NtozThirjzzZuMOBxj8bo58qG3cNpMx4onp54CjSMJm2o9Mfmh/gIOTJbWcwF7UaZc
         A5vkjr/ZNUixhHYKsVeZJYujSZbWoyXFsD7hQ8oQN88EVbFCdkXSPxalyVSFxpMrSm
         Yi7lwHnk3/myA==
Received: by mail-wr1-f47.google.com with SMTP id x6so4443825wrv.13
        for <linux-parisc@vger.kernel.org>; Thu, 02 Sep 2021 11:35:49 -0700 (PDT)
X-Gm-Message-State: AOAM530OpAOdCM8rw1JqG70+9IWhq2TPzDZyD6HRThZjq0eZmGveIxp9
        jsbbNYRKbBcbwahEyn69Y4J6oRplggHW0wG3Puo=
X-Google-Smtp-Source: ABdhPJwXw50b35Xp/Sm6OItDtdXfxuxm1uiQaprOg1qE0e/0Oi4N+hR5obiiQqyU31w4OlXhh/zMXA6Znz88hbvboJM=
X-Received: by 2002:adf:d1c3:: with SMTP id b3mr5574368wrd.286.1630607748505;
 Thu, 02 Sep 2021 11:35:48 -0700 (PDT)
MIME-Version: 1.0
References: <YS6VGsZ7fZtZeu/i@ls3530> <YTDaZAMvAipdvkaB@ls3530>
In-Reply-To: <YTDaZAMvAipdvkaB@ls3530>
From:   Arnd Bergmann <arnd@kernel.org>
Date:   Thu, 2 Sep 2021 18:35:32 +0000
X-Gmail-Original-Message-ID: <CAK8P3a0zwnEUK_ztPRBx0H9VGBoPVY-+aASFV97zSKrL=diXUA@mail.gmail.com>
Message-ID: <CAK8P3a0zwnEUK_ztPRBx0H9VGBoPVY-+aASFV97zSKrL=diXUA@mail.gmail.com>
Subject: Re: [PATCH v2] parisc: Fix boot with kernel v5.14
To:     Helge Deller <deller@gmx.de>
Cc:     Parisc List <linux-parisc@vger.kernel.org>,
        James Bottomley <James.Bottomley@hansenpartnership.com>,
        John David Anglin <dave.anglin@bell.net>
Content-Type: text/plain; charset="UTF-8"
Precedence: bulk
List-ID: <linux-parisc.vger.kernel.org>
X-Mailing-List: linux-parisc@vger.kernel.org

On Thu, Sep 2, 2021 at 2:06 PM Helge Deller <deller@gmx.de> wrote:
>
> Kernel v5.14 has various changes to optimize unaligned memory accesses,
> e.g. commit 0652035a5794 ("asm-generic: unaligned: remove byteshift helpers").
>
> Those changes break the bootloader and other places in kernel for parisc
> which needs byte-wise accesses to unaligned memory.
>
> Here is an updated patch/hack which fixes those boot problems by adding
> a compiler optimization barrier. More info and background can be found in BZ:
> https://gcc.gnu.org/bugzilla/show_bug.cgi?id=102162
>
> Signed-off-by: Helge Deller <deller@gmx.de>

Right, this should fix it, but I tend to agree with what Andrew Pinski
said: the existing version is actually correct and allows valid
optimizations on static variables as long as those are correctly
annotated in C. The problem on parisc seems to be that at least
one variable is generated by the linker in a way that is incompatible
with the psABI but declared as a regular __u32.

       Arnd
